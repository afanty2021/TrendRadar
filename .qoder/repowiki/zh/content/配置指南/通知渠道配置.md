# 通知渠道配置

<cite>
**本文引用的文件**
- [config/config.yaml](file://config/config.yaml)
- [trendradar/core/loader.py](file://trendradar/core/loader.py)
- [trendradar/core/config.py](file://trendradar/core/config.py)
- [trendradar/notification/senders.py](file://trendradar/notification/senders.py)
- [docker/.env](file://docker/.env)
- [README.md](file://README.md)
- [README-EN.md](file://README-EN.md)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考量](#性能考量)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介
本章节聚焦于 notification.webhooks 通知渠道配置，系统性梳理飞书、钉钉、企业微信、Telegram、邮件、ntfy、Bark 和 Slack 的配置项、分号分隔的多账号机制、配对参数一致性校验、URL 格式要点、安全风险与防护策略，并结合代码实现给出可操作的配置建议与排障思路。

## 项目结构
与通知渠道配置直接相关的文件与职责如下：
- 配置入口与合并：config/config.yaml 提供默认配置；trendradar/core/loader.py 从 YAML 与环境变量加载并合并，打印渠道来源与数量。
- 多账号解析与校验：trendradar/core/config.py 提供 parse_multi_account_config、validate_paired_configs、limit_accounts 等工具。
- 发送器实现：trendradar/notification/senders.py 实现各渠道发送逻辑，统一支持分批发送与批次头部预留。
- 环境变量模板：docker/.env 提供多账号配置的示例字段与注释。
- 文档与示例：README.md/README-EN.md 提供各渠道的配置步骤、URL 格式与配对示例。

```mermaid
graph TB
A["config/config.yaml<br/>默认配置"] --> B["trendradar/core/loader.py<br/>加载与合并配置"]
C["docker/.env<br/>环境变量模板"] --> B
D["trendradar/core/config.py<br/>多账号解析/校验"] --> B
B --> E["trendradar/notification/senders.py<br/>各渠道发送器"]
E --> F["飞书/钉钉/企业微信/Telegram/邮件/ntfy/Bark/Slack"]
```

图表来源
- [config/config.yaml](file://config/config.yaml#L129-L156)
- [trendradar/core/loader.py](file://trendradar/core/loader.py#L166-L196)
- [trendradar/core/config.py](file://trendradar/core/config.py#L11-L153)
- [trendradar/notification/senders.py](file://trendradar/notification/senders.py#L61-L1036)
- [docker/.env](file://docker/.env#L44-L86)

章节来源
- [config/config.yaml](file://config/config.yaml#L129-L156)
- [trendradar/core/loader.py](file://trendradar/core/loader.py#L166-L196)
- [trendradar/core/config.py](file://trendradar/core/config.py#L11-L153)
- [trendradar/notification/senders.py](file://trendradar/notification/senders.py#L61-L1036)
- [docker/.env](file://docker/.env#L44-L86)

## 核心组件
- 配置加载与来源打印：从 YAML 与环境变量加载 webhooks 配置，打印“渠道来源（环境变量/配置文件）+账号数量”，并对 Telegram、ntfy、邮件等进行必要性与配对校验。
- 多账号解析与限制：统一使用分号分隔；对 Telegram/ntfy 的配对参数进行数量一致性校验；对每个渠道的账号数量进行上限限制（默认 3）。
- 发送器实现：各渠道均支持分批发送，预留批次头部空间，避免超限；对 Slack/ntfy/Bark 等有特定格式与大小限制的通道进行适配。

章节来源
- [trendradar/core/loader.py](file://trendradar/core/loader.py#L166-L273)
- [trendradar/core/config.py](file://trendradar/core/config.py#L11-L153)
- [trendradar/notification/senders.py](file://trendradar/notification/senders.py#L61-L1036)

## 架构总览
通知配置在运行时的处理流程如下：

```mermaid
sequenceDiagram
participant Yaml as "config/config.yaml"
participant Env as "环境变量(.env/Actions Secrets)"
participant Loader as "loader.py"
participant Utils as "config.py"
participant Sender as "senders.py"
Yaml-->>Loader : 读取默认webhooks配置
Env-->>Loader : 读取同名环境变量
Loader->>Utils : 解析多账号/校验配对/限制数量
Loader-->>Sender : 合并后的渠道配置
Sender->>Sender : 分批发送(预留头部/按渠道规则)
Sender-->>Sender : 返回发送结果
```

图表来源
- [trendradar/core/loader.py](file://trendradar/core/loader.py#L166-L273)
- [trendradar/core/config.py](file://trendradar/core/config.py#L11-L153)
- [trendradar/notification/senders.py](file://trendradar/notification/senders.py#L61-L1036)

## 详细组件分析

### 配置项与用途总览
以下为 notification.webhooks 下各渠道的关键配置项与用途说明（来源于配置文件与环境变量模板）：

- 飞书（Feishu）
  - 配置项：feishu_url
  - 用途：飞书机器人 Webhook URL；支持多账号分号分隔
  - 批次大小：默认由通知配置决定
- 钉钉（DingTalk）
  - 配置项：dingtalk_url
  - 用途：钉钉机器人 Webhook URL；支持多账号分号分隔
  - 批次大小：默认由通知配置决定
- 企业微信（WeCom/WeWork）
  - 配置项：wework_url、wework_msg_type
  - 用途：企业微信机器人 Webhook URL；支持多账号分号分隔；消息类型支持 markdown 或 text
- Telegram
  - 配置项：telegram_bot_token、telegram_chat_id
  - 用途：Telegram Bot Token 与 Chat ID；必须配对，数量一致
- 邮件（Email）
  - 配置项：email_from、email_password、email_to、email_smtp_server、email_smtp_port
  - 用途：发件人邮箱、授权码、收件人（逗号分隔）、SMTP 服务器与端口
- ntfy
  - 配置项：ntfy_server_url、ntfy_topic、ntfy_token
  - 用途：ntfy 服务器地址、主题（多账号分号分隔）、访问令牌（可选，多账号分号分隔，空占位）
- Bark
  - 配置项：bark_url
  - 用途：Bark 推送 URL（多账号分号分隔，格式包含 device_key）
- Slack
  - 配置项：slack_webhook_url
  - 用途：Slack Incoming Webhook URL；支持多账号分号分隔

章节来源
- [config/config.yaml](file://config/config.yaml#L129-L156)
- [docker/.env](file://docker/.env#L44-L86)

### 多账号支持与分号分隔机制
- 分号分隔：所有多账号配置均使用英文分号分隔（如 "url1;url2;url3"）。
- 占位符：对于需要配对但某账号无令牌的场景（如 ntfy 的 token），可在相应位置使用空字符串占位，以保证数组索引一一对应。
- 数量限制：每个渠道最多支持 max_accounts_per_channel 个账号（默认 3），超出将被截断并发出警告。
- 配对参数一致性：Telegram 的 token 与 chat_id、ntfy 的 topic 与 token（当提供时）必须数量一致，否则该渠道推送将被跳过。

章节来源
- [trendradar/core/loader.py](file://trendradar/core/loader.py#L200-L273)
- [trendradar/core/config.py](file://trendradar/core/config.py#L11-L153)
- [README.md](file://README.md#L2780-L2905)
- [README-EN.md](file://README-EN.md#L902-L917)

### 配置加载与来源打印
- 环境变量优先：若环境变量存在同名配置项，将覆盖 config.yaml 中的默认值。
- 来源标注：打印时区分“环境变量”或“配置文件”来源，并标注账号数量。
- Telegram/ntfy/邮件/Slack/Bark：均进行必要的存在性与配对校验，ntfy 还会根据是否提供 token 决定是否启用鉴权头。

章节来源
- [trendradar/core/loader.py](file://trendradar/core/loader.py#L166-L196)
- [trendradar/core/loader.py](file://trendradar/core/loader.py#L200-L273)

### 各渠道配置要点与URL格式

- 飞书（Feishu）
  - 配置项：feishu_url
  - 多账号：分号分隔
  - 发送器行为：按批次大小分批发送，预留头部空间
  - 参考路径：[send_to_feishu](file://trendradar/notification/senders.py#L61-L168)

- 钉钉（DingTalk）
  - 配置项：dingtalk_url
  - 多账号：分号分隔
  - 发送器行为：按批次大小分批发送，预留头部空间
  - 参考路径：[send_to_dingtalk](file://trendradar/notification/senders.py#L170-L266)

- 企业微信（WeCom/WeWork）
  - 配置项：wework_url、wework_msg_type
  - 多账号：分号分隔；消息类型支持 markdown 或 text
  - 发送器行为：按批次大小分批发送，text 模式会去除 markdown 语法
  - 参考路径：[send_to_wework](file://trendradar/notification/senders.py#L268-L375)

- Telegram
  - 配置项：telegram_bot_token、telegram_chat_id
  - 配对要求：token 与 chat_id 数量必须一致
  - 发送器行为：按批次大小分批发送，HTML parse_mode
  - 参考路径：[send_to_telegram](file://trendradar/notification/senders.py#L377-L472)

- 邮件（Email）
  - 配置项：email_from、email_password、email_to、email_smtp_server、email_smtp_port
  - 多收件人：逗号分隔
  - 发送器行为：自动识别 SMTP 配置或使用自定义；HTML 报告文件必须存在
  - 参考路径：[send_to_email](file://trendradar/notification/senders.py#L474-L628)

- ntfy
  - 配置项：ntfy_server_url、ntfy_topic、ntfy_token
  - 多账号：topic 与 token（可选）分号分隔，token 可用空占位
  - 发送器行为：严格遵守 4KB 限制；公共服务器建议间隔；支持 Authorization 头
  - 参考路径：[send_to_ntfy](file://trendradar/notification/senders.py#L630-L800)

- Bark
  - 配置项：bark_url
  - 多账号：分号分隔；URL 中包含 device_key
  - 发送器行为：严格遵守 4KB 限制；APNs 推送
  - 参考路径：[send_to_bark](file://trendradar/notification/senders.py#L805-L948)

- Slack
  - 配置项：slack_webhook_url
  - 多账号：分号分隔
  - 发送器行为：按批次大小分批发送；将 Markdown 转换为 mrkdwn
  - 参考路径：[send_to_slack](file://trendradar/notification/senders.py#L950-L1036)

章节来源
- [config/config.yaml](file://config/config.yaml#L129-L156)
- [docker/.env](file://docker/.env#L44-L86)
- [trendradar/notification/senders.py](file://trendradar/notification/senders.py#L61-L1036)

### URL 格式示例与要点
- Slack Webhook 结构
  - 形如：https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX
  - 发送器期望返回 "ok" 文本表示成功
  - 参考路径：[Slack 发送器](file://trendradar/notification/senders.py#L950-L1036)
- Telegram
  - Bot Token 与 Chat ID 必须配对，数量一致
  - 参考路径：[Telegram 发送器](file://trendradar/notification/senders.py#L377-L472)
- ntfy
  - topic 与 token（可选）需一一对应；公共服务器建议间隔
  - 参考路径：[ntfy 发送器](file://trendradar/notification/senders.py#L630-L800)
- Bark
  - URL 中包含 device_key；严格遵守 4KB 限制
  - 参考路径：[Bark 发送器](file://trendradar/notification/senders.py#L805-L948)

章节来源
- [README.md](file://README.md#L1508-L1605)
- [README-EN.md](file://README-EN.md#L2747-L2862)
- [trendradar/notification/senders.py](file://trendradar/notification/senders.py#L950-L1036)

### 安全警告与风险防范
- 绝对不要在配置文件中明文存放敏感信息（webhook、token、密码等）
- GitHub Fork 用户严禁在 config.yaml 中填写任何 webhooks
- 推荐使用 GitHub Secrets 或 .env 环境变量注入敏感配置
- 若配置泄露，可能引发：
  - 垃圾广告推送泛滥
  - 恶意消息轰炸、钓鱼链接传播
  - 账号风控与封禁风险
- 防范措施：
  - 使用环境变量或 Actions Secrets
  - 限制每个渠道账号数量（默认 3）
  - 定期轮换 token 与 webhook
  - 为 Slack/ntfy/Bark 等设置访问控制（token/私有主题）

章节来源
- [config/config.yaml](file://config/config.yaml#L107-L129)
- [README.md](file://README.md#L2780-L2905)
- [README-EN.md](file://README-EN.md#L902-L917)

## 依赖关系分析
- 配置加载依赖：
  - config/config.yaml 提供默认值
  - trendradar/core/loader.py 合并环境变量与 YAML
  - trendradar/core/config.py 提供解析与校验工具
- 发送器依赖：
  - trendradar/notification/senders.py 依赖分批工具与格式转换
  - 各渠道发送器对自身格式与大小限制有严格约束

```mermaid
graph LR
CFG["config/config.yaml"] --> LDR["loader.py"]
ENV["环境变量(.env/Secrets)"] --> LDR
LDR --> UTL["config.py"]
LDR --> SND["senders.py"]
UTL --> SND
```

图表来源
- [config/config.yaml](file://config/config.yaml#L129-L156)
- [trendradar/core/loader.py](file://trendradar/core/loader.py#L166-L273)
- [trendradar/core/config.py](file://trendradar/core/config.py#L11-L153)
- [trendradar/notification/senders.py](file://trendradar/notification/senders.py#L61-L1036)

章节来源
- [trendradar/core/loader.py](file://trendradar/core/loader.py#L166-L273)
- [trendradar/core/config.py](file://trendradar/core/config.py#L11-L153)
- [trendradar/notification/senders.py](file://trendradar/notification/senders.py#L61-L1036)

## 性能考量
- 分批发送与头部预留：各渠道发送器均预留批次头部空间，避免超限导致失败。
- 批次大小差异：不同渠道的默认批次大小不同，应结合实际消息体量与平台限制合理调整。
- 速率限制与重试：ntfy 在公共服务器上遇到 429 会等待并重试；Bark/APNs 严格限制 4KB。
- 时间窗口与每日仅一次：可通过推送记录管理器控制推送频率，避免过度打扰。

章节来源
- [trendradar/notification/senders.py](file://trendradar/notification/senders.py#L61-L1036)
- [trendradar/core/loader.py](file://trendradar/core/loader.py#L81-L116)

## 故障排查指南
- 配置项缺失或为空
  - 现象：渠道未被打印为有效来源，或被跳过
  - 排查：确认环境变量或 YAML 中对应项是否填写；Telegram/ntfy 需要配对参数齐全
  - 参考路径：[来源打印逻辑](file://trendradar/core/loader.py#L200-L273)
- 配对参数数量不一致（Telegram/ntfy）
  - 现象：打印“配对配置数量不一致，将跳过该渠道推送”
  - 排查：确保 token/chat_id 或 topic/token 数量一致，必要时使用空占位
  - 参考路径：[配对校验](file://trendradar/core/config.py#L40-L95)
- 账号数量超过限制
  - 现象：打印“超过最大限制 X，只使用前 X 个”
  - 排查：减少多账号数量或调整 MAX_ACCOUNTS_PER_CHANNEL
  - 参考路径：[账号限制](file://trendradar/core/config.py#L97-L126)
- Slack 返回非 "ok"
  - 现象：发送失败
  - 排查：确认 webhook URL 正确、频道可写、Markdown 转换是否正确
  - 参考路径：[Slack 发送器](file://trendradar/notification/senders.py#L950-L1036)
- ntfy 被拒绝或 429
  - 现象：消息过大（>4KB）或速率限制
  - 排查：缩短消息或降低发送频率；公共服务器建议间隔
  - 参考路径：[ntfy 发送器](file://trendradar/notification/senders.py#L630-L800)
- Bark 消息过大
  - 现象：APNs 拒绝
  - 排查：缩短消息或拆分批次
  - 参考路径：[Bark 发送器](file://trendradar/notification/senders.py#L805-L948)
- 邮件发送失败
  - 现象：HTML 报告不存在或 SMTP 认证错误
  - 排查：确保 formats.html 启用；核对 SMTP 服务器与端口；使用授权码
  - 参考路径：[邮件发送器](file://trendradar/notification/senders.py#L474-L628)

章节来源
- [trendradar/core/loader.py](file://trendradar/core/loader.py#L200-L273)
- [trendradar/core/config.py](file://trendradar/core/config.py#L40-L126)
- [trendradar/notification/senders.py](file://trendradar/notification/senders.py#L474-L1036)

## 结论
- notification.webhooks 提供统一的多渠道通知能力，支持分号分隔的多账号与严格的配对校验。
- 安全性是首要原则：敏感信息必须通过环境变量或 GitHub Secrets 注入，严禁明文写入配置文件。
- 合理设置批次大小与时间窗口，结合各渠道的格式与大小限制，可获得稳定可靠的推送体验。

## 附录
- 多账号配置示例（来自文档与环境变量模板）
  - 飞书/钉钉/企业微信/Slack：使用分号分隔多个 URL
  - Telegram：token 与 chat_id 数量一致
  - ntfy：topic 与 token（可选）一一对应，token 可用空占位
  - 邮件：收件人使用逗号分隔
- 参考路径：
  - [README.md 多账号示例](file://README.md#L2780-L2905)
  - [README-EN.md 多账号示例](file://README-EN.md#L2747-L2862)
  - [docker/.env 多账号字段](file://docker/.env#L44-L86)