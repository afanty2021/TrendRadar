# 性能与配置问题

<cite>
**本文引用的文件**
- [config.yaml](file://config/config.yaml)
- [fetcher.py](file://trendradar/crawler/fetcher.py)
- [local.py](file://trendradar/storage/local.py)
- [remote.py](file://trendradar/storage/remote.py)
- [schema.sql](file://trendradar/storage/schema.sql)
- [system.py](file://mcp_server/tools/system.py)
- [server.py](file://mcp_server/server.py)
- [time.py](file://trendradar/utils/time.py)
- [requirements.txt](file://requirements.txt)
- [docker-compose.yml](file://docker/docker-compose.yml)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构与关键组件](#项目结构与关键组件)
3. [核心性能参数与推荐范围](#核心性能参数与推荐范围)
4. [架构概览与数据流](#架构概览与数据流)
5. [详细问题排查与优化建议](#详细问题排查与优化建议)
6. [依赖关系与耦合分析](#依赖关系与耦合分析)
7. [性能考量与资源监控](#性能考量与资源监控)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)

## 简介
本指南聚焦于TrendRadar在实际运行中常见的性能与配置问题，围绕以下目标展开：降低高频率爬取导致的IP封禁风险、缓解本地存储空间压力、提升MCP服务响应稳定性、以及确保配置文件生效与环境变量覆盖规则清晰。文档提供可落地的参数调整建议、可视化流程图与排障步骤，帮助您稳定高效地运行系统。

## 项目结构与关键组件
- 配置中心：config/config.yaml集中管理爬虫、存储、推送、权重等关键参数；docker-compose.yml提供环境变量覆盖能力。
- 爬虫层：trendradar/crawler/fetcher.py负责批量平台数据抓取与请求间隔控制。
- 存储层：trendradar/storage/local.py与trendradar/storage/remote.py分别实现本地SQLite与S3兼容远程存储；schema.sql定义数据库表结构与索引。
- MCP服务：mcp_server/server.py提供FastMCP 2.0工具接口；mcp_server/tools/system.py支持手动触发爬取、系统状态查询与保存行为。
- 时间工具：trendradar/utils/time.py统一时区与时间格式化，保障跨组件一致性。
- 依赖与版本：requirements.txt声明fastmcp、websockets、boto3等关键依赖，影响MCP与S3功能稳定性。

```mermaid
graph TB
subgraph "配置与环境"
CFG["config/config.yaml"]
DC["docker/docker-compose.yml"]
end
subgraph "爬虫层"
FETCH["trendradar/crawler/fetcher.py"]
end
subgraph "存储层"
LCL["trendradar/storage/local.py"]
REM["trendradar/storage/remote.py"]
SCH["trendradar/storage/schema.sql"]
end
subgraph "MCP服务"
SRV["mcp_server/server.py"]
SYS["mcp_server/tools/system.py"]
end
TIME["trendradar/utils/time.py"]
CFG --> FETCH
CFG --> LCL
CFG --> REM
DC --> SRV
DC --> SYS
FETCH --> LCL
FETCH --> REM
LCL --> SCH
REM --> SCH
SRV --> SYS
SRV --> LCL
SRV --> REM
SYS --> FETCH
TIME --> LCL
TIME --> REM
```

图表来源
- [config.yaml](file://config/config.yaml#L53-L60)
- [fetcher.py](file://trendradar/crawler/fetcher.py#L117-L185)
- [local.py](file://trendradar/storage/local.py#L1-L120)
- [remote.py](file://trendradar/storage/remote.py#L1-L120)
- [schema.sql](file://trendradar/storage/schema.sql#L1-L118)
- [server.py](file://mcp_server/server.py#L784-L800)
- [system.py](file://mcp_server/tools/system.py#L68-L263)
- [time.py](file://trendradar/utils/time.py#L15-L64)
- [docker-compose.yml](file://docker/docker-compose.yml#L1-L88)

章节来源
- [config.yaml](file://config/config.yaml#L53-L60)
- [fetcher.py](file://trendradar/crawler/fetcher.py#L117-L185)
- [local.py](file://trendradar/storage/local.py#L1-L120)
- [remote.py](file://trendradar/storage/remote.py#L1-L120)
- [schema.sql](file://trendradar/storage/schema.sql#L1-L118)
- [server.py](file://mcp_server/server.py#L784-L800)
- [system.py](file://mcp_server/tools/system.py#L68-L263)
- [time.py](file://trendradar/utils/time.py#L15-L64)
- [docker-compose.yml](file://docker/docker-compose.yml#L1-L88)

## 核心性能参数与推荐范围
以下参数直接影响系统性能与稳定性，建议结合业务规模与资源状况进行调整：

- 爬取请求间隔 request_interval（单位毫秒）
  - 建议范围：1000~3000（默认1000）
  - 说明：增大间隔可显著降低被反爬封禁概率；若平台限流严格，建议逐步上调至2000~3000。
  - 参考路径：[config.yaml](file://config/config.yaml#L53-L60)、[fetcher.py](file://trendradar/crawler/fetcher.py#L117-L185)

- 本地数据保留天数 retention_days（单位天）
  - 建议范围：7~30（默认0表示不清理）
  - 说明：定期清理可释放磁盘空间；建议结合存储成本与查询需求设定。
  - 参考路径：[config.yaml](file://config/config.yaml#L27-L30)、[local.py](file://trendradar/storage/local.py#L746-L800)

- 远程数据保留天数 retention_days（单位天）
  - 建议范围：7~30（默认0表示不清理）
  - 说明：远程存储同样建议开启清理，避免对象过多影响拉取与查询性能。
  - 参考路径：[config.yaml](file://config/config.yaml#L35-L46)、[remote.py](file://trendradar/storage/remote.py#L1-L120)

- 远程存储S3配置（endpoint_url、bucket_name、access_key_id、secret_access_key、region）
  - 建议：优先使用环境变量覆盖，避免明文写入仓库；确保签名版本与服务商兼容。
  - 参考路径：[config.yaml](file://config/config.yaml#L35-L46)、[docker-compose.yml](file://docker/docker-compose.yml#L61-L66)、[remote.py](file://trendradar/storage/remote.py#L93-L116)

- MCP服务依赖版本 fastmcp、websockets、boto3
  - 建议：保持与requirements.txt一致，避免版本冲突导致连接异常或功能缺失。
  - 参考路径：[requirements.txt](file://requirements.txt#L1-L7)

- 推送时间窗口 push_window（enabled、start、end、once_per_day）
  - 建议：合理设置窗口，避免非工作时段打扰；一次性推送避免重复触发。
  - 参考路径：[config.yaml](file://config/config.yaml#L93-L106)

- 报告模式 report.mode 与排序优先级 sort_by_position_first
  - 建议：根据使用场景选择“daily”“current”“incremental”，必要时调整排序优先级。
  - 参考路径：[config.yaml](file://config/config.yaml#L75-L81)

章节来源
- [config.yaml](file://config/config.yaml#L27-L46)
- [config.yaml](file://config/config.yaml#L53-L60)
- [config.yaml](file://config/config.yaml#L75-L81)
- [config.yaml](file://config/config.yaml#L93-L106)
- [fetcher.py](file://trendradar/crawler/fetcher.py#L117-L185)
- [local.py](file://trendradar/storage/local.py#L746-L800)
- [remote.py](file://trendradar/storage/remote.py#L93-L116)
- [requirements.txt](file://requirements.txt#L1-L7)
- [docker-compose.yml](file://docker/docker-compose.yml#L61-L66)

## 架构概览与数据流
下图展示了从爬取到存储再到MCP查询的关键流程，以及远程存储与本地清理的协同关系。

```mermaid
sequenceDiagram
participant User as "用户/调度器"
participant MCP as "MCP服务(server.py)"
participant Sys as "系统工具(system.py)"
participant Fetch as "数据获取(fetcher.py)"
participant StoreLocal as "本地存储(local.py)"
participant StoreRemote as "远程存储(remote.py)"
User->>MCP : 触发爬取/查询
MCP->>Sys : trigger_crawl()/get_*_news()
Sys->>Fetch : crawl_websites(ids, request_interval)
Fetch-->>Sys : 结果/失败平台
alt 保存到本地
Sys->>StoreLocal : save_news_data()/save_txt_snapshot()/save_html_report()
StoreLocal-->>Sys : 成功/失败
else 保存到远程
Sys->>StoreRemote : save_news_data()
StoreRemote-->>Sys : 成功/失败
end
Sys-->>MCP : 结果含保存状态
MCP-->>User : 返回数据/状态
```

图表来源
- [server.py](file://mcp_server/server.py#L627-L660)
- [system.py](file://mcp_server/tools/system.py#L68-L263)
- [fetcher.py](file://trendradar/crawler/fetcher.py#L117-L185)
- [local.py](file://trendradar/storage/local.py#L113-L288)
- [remote.py](file://trendradar/storage/remote.py#L312-L512)

## 详细问题排查与优化建议

### 1. 高频率爬取导致IP被封
- 现象：平台返回异常、失败平台增多、网络超时或限流。
- 根因：request_interval过小，请求过于密集。
- 优化策略：
  - 提升request_interval（建议1500~3000），并在平台间加入随机抖动。
  - 启用代理（use_proxy与default_proxy），并测试不同代理稳定性。
  - 降低并发平台数量，分批抓取。
- 参考路径：
  - [config.yaml](file://config/config.yaml#L53-L60)
  - [fetcher.py](file://trendradar/crawler/fetcher.py#L117-L185)

```mermaid
flowchart TD
Start(["开始抓取"]) --> CheckInterval["检查 request_interval 配置"]
CheckInterval --> TooSmall{"间隔过小？"}
TooSmall --> |是| Increase["提高 request_interval<br/>增加随机抖动"]
TooSmall --> |否| CheckProxy["检查代理配置"]
CheckProxy --> ProxyOn{"启用代理？"}
ProxyOn --> |否| EnableProxy["启用代理并测试稳定性"]
ProxyOn --> |是| Batch["减少并发平台，分批抓取"]
Increase --> Batch
EnableProxy --> Batch
Batch --> End(["结束"])
```

图表来源
- [config.yaml](file://config/config.yaml#L53-L60)
- [fetcher.py](file://trendradar/crawler/fetcher.py#L117-L185)

章节来源
- [config.yaml](file://config/config.yaml#L53-L60)
- [fetcher.py](file://trendradar/crawler/fetcher.py#L117-L185)

### 2. 本地存储空间不足
- 现象：磁盘空间耗尽、写入失败、容器只读卷报错。
- 根因：未启用retention_days清理，或输出目录未挂载到持久化卷。
- 优化策略：
  - 在config.yaml中设置local.retention_days（建议7~30）。
  - 在Docker环境中通过LOCAL_RETENTION_DAYS覆盖。
  - 确认docker-compose.yml中output卷挂载为可写。
  - 如需长期归档，切换storage.backend为remote并配置S3。
- 参考路径：
  - [config.yaml](file://config/config.yaml#L27-L30)
  - [docker-compose.yml](file://docker/docker-compose.yml#L10-L13)
  - [docker-compose.yml](file://docker/docker-compose.yml#L55-L59)
  - [local.py](file://trendradar/storage/local.py#L746-L800)

```mermaid
flowchart TD
Start(["发现磁盘不足"]) --> CheckCfg["检查 local.retention_days 配置"]
CheckCfg --> Enabled{"已启用清理？"}
Enabled --> |否| SetDays["设置 retention_days=7/14/30"]
Enabled --> |是| CheckVol["检查输出卷挂载"]
SetDays --> CheckVol
CheckVol --> Mounted{"已挂载到持久化卷？"}
Mounted --> |否| FixMount["修正 docker-compose.yml 卷挂载"]
Mounted --> |是| SwitchRemote["考虑切换 storage.backend=remote"]
FixMount --> SwitchRemote
SwitchRemote --> End(["结束"])
```

图表来源
- [config.yaml](file://config/config.yaml#L27-L30)
- [docker-compose.yml](file://docker/docker-compose.yml#L10-L13)
- [docker-compose.yml](file://docker/docker-compose.yml#L55-L59)
- [local.py](file://trendradar/storage/local.py#L746-L800)

章节来源
- [config.yaml](file://config/config.yaml#L27-L30)
- [docker-compose.yml](file://docker/docker-compose.yml#L10-L13)
- [docker-compose.yml](file://docker/docker-compose.yml#L55-L59)
- [local.py](file://trendradar/storage/local.py#L746-L800)

### 3. MCP服务响应延迟
- 现象：MCP工具调用慢、WebSocket连接不稳定、工具返回延迟。
- 根因：FastMCP版本不匹配、网络波动、远程存储拉取/上传开销大、查询未命中索引。
- 优化策略：
  - 确认requirements.txt中fastmcp、websockets、boto3版本，避免冲突。
  - 优先使用本地存储查询；必要时通过sync_from_remote拉取近期数据。
  - 优化查询：确保schema.sql索引生效（平台、时间、标题、URL+平台唯一索引）。
  - 检查MCP服务日志与容器资源（CPU/内存/网络）。
- 参考路径：
  - [requirements.txt](file://requirements.txt#L1-L7)
  - [server.py](file://mcp_server/server.py#L662-L703)
  - [remote.py](file://trendradar/storage/remote.py#L178-L274)
  - [schema.sql](file://trendradar/storage/schema.sql#L96-L118)

```mermaid
sequenceDiagram
participant Client as "客户端"
participant MCP as "MCP服务"
participant Store as "存储后端"
participant Net as "网络/依赖"
Client->>MCP : 调用工具如 get_latest_news
MCP->>Store : 读取/合并数据
Store-->>MCP : 返回数据
MCP-->>Client : 响应结果
Note over MCP,Net : 若依赖版本不匹配或网络波动，响应会变慢
```

图表来源
- [server.py](file://mcp_server/server.py#L113-L151)
- [remote.py](file://trendradar/storage/remote.py#L178-L274)
- [schema.sql](file://trendradar/storage/schema.sql#L96-L118)
- [requirements.txt](file://requirements.txt#L1-L7)

章节来源
- [requirements.txt](file://requirements.txt#L1-L7)
- [server.py](file://mcp_server/server.py#L113-L151)
- [remote.py](file://trendradar/storage/remote.py#L178-L274)
- [schema.sql](file://trendradar/storage/schema.sql#L96-L118)

### 4. 配置文件生效与环境变量覆盖规则
- 现象：修改config.yaml后未生效、MCP返回默认值、容器内行为异常。
- 根因：配置加载顺序、环境变量覆盖优先级、Docker只读卷限制。
- 优化策略：
  - 优先使用环境变量覆盖（如STORAGE_BACKEND、LOCAL_RETENTION_DAYS、S3_*等）。
  - 在docker-compose.yml中显式设置环境变量，确保容器启动时生效。
  - 确认system.py在触发爬取时读取config.yaml并转换为NewsData，保存失败时会返回明确提示（如只读卷）。
  - YAML格式校验：确保缩进与键名正确，避免解析失败。
- 参考路径：
  - [docker-compose.yml](file://docker/docker-compose.yml#L14-L73)
  - [system.py](file://mcp_server/tools/system.py#L98-L171)
  - [config.yaml](file://config/config.yaml#L1-L187)

```mermaid
flowchart TD
Start(["修改配置"]) --> EnvCheck["检查 docker-compose 环境变量"]
EnvCheck --> ApplyEnv{"环境变量覆盖已设置？"}
ApplyEnv --> |否| SetEnv["在 docker-compose.yml 中添加对应环境变量"]
ApplyEnv --> |是| LoadCfg["确认 system.py 正确读取 config.yaml"]
SetEnv --> LoadCfg
LoadCfg --> SaveCheck{"保存到本地/远程？"}
SaveCheck --> |是| VolCheck["检查卷挂载与权限"]
SaveCheck --> |否| SkipSave["仅内存返回，不影响查询"]
VolCheck --> End(["结束"])
SkipSave --> End
```

图表来源
- [docker-compose.yml](file://docker/docker-compose.yml#L14-L73)
- [system.py](file://mcp_server/tools/system.py#L98-L171)
- [config.yaml](file://config/config.yaml#L1-L187)

章节来源
- [docker-compose.yml](file://docker/docker-compose.yml#L14-L73)
- [system.py](file://mcp_server/tools/system.py#L98-L171)
- [config.yaml](file://config/config.yaml#L1-L187)

## 依赖关系与耦合分析
- 组件耦合
  - fetcher依赖requests与随机退避重试，与config.yaml的request_interval耦合。
  - storage.local与storage.remote共享相同的NewsData模型与schema.sql表结构，耦合度高。
  - MCP server通过tools.system触发爬取并调用storage，依赖requirements.txt中的fastmcp/websockets/boto3。
- 外部依赖
  - S3兼容存储依赖boto3；MCP依赖FastMCP与websockets；时间处理依赖pytz。
- 循环依赖
  - 未发现循环导入；各模块职责清晰。

```mermaid
graph LR
FETCH["fetcher.py"] --> CFG["config.yaml"]
SYS["system.py"] --> FETCH
SYS --> LCL["local.py"]
SYS --> REM["remote.py"]
SRV["server.py"] --> SYS
LCL --> SCH["schema.sql"]
REM --> SCH
SRV --> REQ["requirements.txt"]
```

图表来源
- [fetcher.py](file://trendradar/crawler/fetcher.py#L117-L185)
- [config.yaml](file://config/config.yaml#L53-L60)
- [system.py](file://mcp_server/tools/system.py#L68-L263)
- [local.py](file://trendradar/storage/local.py#L113-L288)
- [remote.py](file://trendradar/storage/remote.py#L312-L512)
- [server.py](file://mcp_server/server.py#L784-L800)
- [schema.sql](file://trendradar/storage/schema.sql#L1-L118)
- [requirements.txt](file://requirements.txt#L1-L7)

章节来源
- [fetcher.py](file://trendradar/crawler/fetcher.py#L117-L185)
- [system.py](file://mcp_server/tools/system.py#L68-L263)
- [local.py](file://trendradar/storage/local.py#L113-L288)
- [remote.py](file://trendradar/storage/remote.py#L312-L512)
- [server.py](file://mcp_server/server.py#L784-L800)
- [schema.sql](file://trendradar/storage/schema.sql#L1-L118)
- [requirements.txt](file://requirements.txt#L1-L7)

## 性能考量与资源监控
- CPU/内存/磁盘
  - 定期检查容器资源使用率，避免频繁GC或I/O阻塞。
  - 本地存储清理与远程上传均涉及I/O，建议在低峰期执行。
- 网络
  - S3上传采用明确Content-Length避免chunked encoding问题；若服务商为腾讯云COS，注意签名版本差异。
- 时间与索引
  - 使用schema.sql索引加速查询；统一时区由time.py提供，避免跨时区查询偏差。
- 参考路径：
  - [remote.py](file://trendradar/storage/remote.py#L225-L274)
  - [schema.sql](file://trendradar/storage/schema.sql#L96-L118)
  - [time.py](file://trendradar/utils/time.py#L15-L64)

章节来源
- [remote.py](file://trendradar/storage/remote.py#L225-L274)
- [schema.sql](file://trendradar/storage/schema.sql#L96-L118)
- [time.py](file://trendradar/utils/time.py#L15-L64)

## 故障排查指南
- IP被封/限流
  - 提升request_interval，启用代理，分批抓取。
  - 参考：[config.yaml](file://config/config.yaml#L53-L60)、[fetcher.py](file://trendradar/crawler/fetcher.py#L117-L185)
- 本地空间不足
  - 开启local.retention_days，检查卷挂载，必要时切换remote。
  - 参考：[config.yaml](file://config/config.yaml#L27-L30)、[docker-compose.yml](file://docker/docker-compose.yml#L10-L13)、[local.py](file://trendradar/storage/local.py#L746-L800)
- MCP响应慢
  - 校验fastmcp/websockets/boto3版本，优化查询索引，必要时拉取远程数据到本地。
  - 参考：[requirements.txt](file://requirements.txt#L1-L7)、[server.py](file://mcp_server/server.py#L662-L703)、[schema.sql](file://trendradar/storage/schema.sql#L96-L118)
- 配置不生效
  - 确认docker-compose环境变量覆盖，检查system.py读取与保存逻辑。
  - 参考：[docker-compose.yml](file://docker/docker-compose.yml#L14-L73)、[system.py](file://mcp_server/tools/system.py#L98-L171)

章节来源
- [config.yaml](file://config/config.yaml#L27-L60)
- [fetcher.py](file://trendradar/crawler/fetcher.py#L117-L185)
- [local.py](file://trendradar/storage/local.py#L746-L800)
- [docker-compose.yml](file://docker/docker-compose.yml#L10-L13)
- [requirements.txt](file://requirements.txt#L1-L7)
- [server.py](file://mcp_server/server.py#L662-L703)
- [schema.sql](file://trendradar/storage/schema.sql#L96-L118)
- [system.py](file://mcp_server/tools/system.py#L98-L171)

## 结论
通过合理设置request_interval、启用retention_days清理、切换remote后端与S3配置、校验MCP依赖版本与索引、以及规范环境变量覆盖，可显著提升TrendRadar的运行稳定性与性能。建议在生产环境中结合监控指标持续优化参数，并定期审查配置与依赖版本，确保系统长期可靠运行。