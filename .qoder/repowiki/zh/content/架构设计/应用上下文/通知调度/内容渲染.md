# å†…å®¹æ¸²æŸ“

<cite>
**æœ¬æ–‡å¼•ç”¨çš„æ–‡ä»¶**
- [context.py](file://trendradar/context.py)
- [renderer.py](file://trendradar/notification/renderer.py)
- [formatter.py](file://trendradar/report/formatter.py)
- [helpers.py](file://trendradar/report/helpers.py)
- [config.yaml](file://config/config.yaml)
- [splitter.py](file://trendradar/notification/splitter.py)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [æ¶æ„æ€»è§ˆ](#æ¶æ„æ€»è§ˆ)
5. [è¯¦ç»†ç»„ä»¶åˆ†æ](#è¯¦ç»†ç»„ä»¶åˆ†æ)
6. [ä¾èµ–å…³ç³»åˆ†æ](#ä¾èµ–å…³ç³»åˆ†æ)
7. [æ€§èƒ½è€ƒé‡](#æ€§èƒ½è€ƒé‡)
8. [æ•…éšœæ’æŸ¥æŒ‡å—](#æ•…éšœæ’æŸ¥æŒ‡å—)
9. [ç»“è®º](#ç»“è®º)

## ç®€ä»‹
æœ¬æ–‡ä»¶èšç„¦äº TrendRadar é€šçŸ¥å†…å®¹æ¸²æŸ“ï¼Œç³»ç»Ÿæ€§é˜è¿° AppContext ä¸­çš„ render_feishu ä¸ render_dingtalk æ–¹æ³•ï¼Œä»¥åŠåº•å±‚æ¸²æŸ“å™¨ render_feishu_content ä¸ render_dingtalk_content çš„å®ç°ç»†èŠ‚ã€‚æ–‡æ¡£å°†è§£é‡Šï¼š
- å¦‚ä½•åŸºäºæŠ¥å‘Šæ•°æ®ç”Ÿæˆç¬¦åˆé£ä¹¦ä¸é’‰é’‰æ ¼å¼è§„èŒƒçš„æ¶ˆæ¯å†…å®¹ï¼›
- é£ä¹¦ä¸é’‰é’‰åœ¨æ¶ˆæ¯æ ·å¼ï¼ˆé¢œè‰²æ ‡è®°ã€å›¾æ ‡ä½¿ç”¨ã€åˆ†éš”ç¬¦ï¼‰ä¸Šçš„å·®å¼‚å¤„ç†ï¼›
- reverse_content_order é…ç½®å¯¹å†…å®¹é¡ºåºçš„å½±å“ï¼›
- æ ‡é¢˜ç»Ÿè®¡éƒ¨åˆ†ä¸æ–°å¢æ–°é—»éƒ¨åˆ†çš„æ¸²æŸ“é€»è¾‘ï¼ŒåŒ…æ‹¬çƒ­åº¦ç­‰çº§çš„è§†è§‰åŒºåˆ†ï¼ˆğŸ”¥ã€ğŸ“ˆã€ğŸ“Œï¼‰ä¸å¹³å°æ¥æºæ ‡è¯†ï¼›
- å¤±è´¥å¹³å°ä¿¡æ¯çš„æ¸²æŸ“æ–¹å¼ï¼›
- ç‰ˆæœ¬æ›´æ–°æç¤ºçš„é›†æˆæœºåˆ¶ã€‚

## é¡¹ç›®ç»“æ„
å›´ç»•é€šçŸ¥å†…å®¹æ¸²æŸ“çš„å…³é”®æ–‡ä»¶ä¸èŒè´£å¦‚ä¸‹ï¼š
- trendradar/context.pyï¼šåº”ç”¨ä¸Šä¸‹æ–‡ï¼Œæä¾› render_feishu/render_dingtalk ä¾¿æ·å…¥å£ï¼Œå¹¶é€ä¼ é…ç½®é¡¹ï¼ˆå¦‚åˆ†éš”ç¬¦ã€å†…å®¹é¡ºåºã€æ—¶é—´å‡½æ•°ç­‰ï¼‰ç»™æ¸²æŸ“å™¨ã€‚
- trendradar/notification/renderer.pyï¼šå¹³å°ç‰¹å®šæ¸²æŸ“å™¨ï¼Œåˆ†åˆ«å®ç° render_feishu_content ä¸ render_dingtalk_content çš„å®Œæ•´æ¶ˆæ¯æ‹¼è£…é€»è¾‘ã€‚
- trendradar/report/formatter.pyï¼šæ ‡é¢˜æ ¼å¼åŒ–å·¥å…·ï¼ŒæŒ‰å¹³å°ç”Ÿæˆç»Ÿä¸€çš„æ ‡é¢˜å­—ç¬¦ä¸²ï¼ˆå«æ¥æºã€é“¾æ¥ã€æ—¶é—´ã€çƒ­åº¦æ¬¡æ•°ã€æ–°å¢æ ‡è®°ç­‰ï¼‰ã€‚
- trendradar/report/helpers.pyï¼šæŠ¥å‘Šè¾…åŠ©å‡½æ•°ï¼Œè´Ÿè´£æ¸…æ´—æ ‡é¢˜ã€HTML è½¬ä¹‰ã€æ’åé«˜äº®æ ¼å¼åŒ–ç­‰ã€‚
- config/config.yamlï¼šå…¨å±€é…ç½®ï¼ŒåŒ…å« FEISHU_MESSAGE_SEPARATORã€REVERSE_CONTENT_ORDERã€å„å¹³å°æ‰¹é‡å¤§å°ç­‰ã€‚
- trendradar/notification/splitter.pyï¼šæ¶ˆæ¯åˆ†æ‰¹å¤„ç†æ¨¡å—ï¼Œæä¾›è·¨å¹³å°åˆ†æ‰¹ç­–ç•¥ä¸æ‰¹æ¬¡å¤´éƒ¨é¢„ç•™ï¼Œä¾› AppContext.split_content è°ƒç”¨ã€‚

```mermaid
graph TB
subgraph "åº”ç”¨å±‚"
Ctx["AppContext<br/>æ¸²æŸ“å…¥å£"]
end
subgraph "é€šçŸ¥æ¸²æŸ“å±‚"
Fei["render_feishu_content"]
Ding["render_dingtalk_content"]
end
subgraph "æŠ¥å‘Šæ ¼å¼åŒ–å±‚"
Fmt["format_title_for_platform"]
Help["clean_title / html_escape / format_rank_display"]
end
subgraph "é…ç½®å±‚"
Cfg["config.yaml<br/>FEISHU_MESSAGE_SEPARATOR / REVERSE_CONTENT_ORDER / æ‰¹é‡å¤§å°"]
end
subgraph "åˆ†æ‰¹å±‚"
Split["split_content_into_batches"]
end
Ctx --> Fei
Ctx --> Ding
Fei --> Fmt
Ding --> Fmt
Fmt --> Help
Ctx --> Split
Cfg -.-> Ctx
Cfg -.-> Fei
Cfg -.-> Ding
```

å›¾è¡¨æ¥æº
- [context.py](file://trendradar/context.py#L308-L366)
- [renderer.py](file://trendradar/notification/renderer.py#L1-L261)
- [formatter.py](file://trendradar/report/formatter.py#L1-L224)
- [helpers.py](file://trendradar/report/helpers.py#L1-L126)
- [config.yaml](file://config/config.yaml#L80-L110)
- [splitter.py](file://trendradar/notification/splitter.py#L1-L120)

ç« èŠ‚æ¥æº
- [context.py](file://trendradar/context.py#L308-L366)
- [renderer.py](file://trendradar/notification/renderer.py#L1-L261)
- [formatter.py](file://trendradar/report/formatter.py#L1-L224)
- [helpers.py](file://trendradar/report/helpers.py#L1-L126)
- [config.yaml](file://config/config.yaml#L80-L110)
- [splitter.py](file://trendradar/notification/splitter.py#L1-L120)

## æ ¸å¿ƒç»„ä»¶
- AppContext.render_feishuï¼šè°ƒç”¨ render_feishu_contentï¼Œæ³¨å…¥åˆ†éš”ç¬¦ã€å†…å®¹é¡ºåºä¸æ—¶é—´å‡½æ•°ï¼Œè¿”å›é£ä¹¦æ¶ˆæ¯æ–‡æœ¬ã€‚
- AppContext.render_dingtalkï¼šè°ƒç”¨ render_dingtalk_contentï¼Œæ³¨å…¥å†…å®¹é¡ºåºä¸æ—¶é—´å‡½æ•°ï¼Œè¿”å›é’‰é’‰æ¶ˆæ¯æ–‡æœ¬ã€‚
- render_feishu_contentï¼šæŒ‰é£ä¹¦æ ¼å¼è§„èŒƒæ‹¼è£…â€œçƒ­ç‚¹è¯æ±‡ç»Ÿè®¡â€â€œæ–°å¢çƒ­ç‚¹æ–°é—»â€â€œå¤±è´¥å¹³å°â€ä¸æ—¶é—´/ç‰ˆæœ¬æç¤ºã€‚
- render_dingtalk_contentï¼šæŒ‰é’‰é’‰æ ¼å¼è§„èŒƒæ‹¼è£…â€œå¤´éƒ¨ä¿¡æ¯â€â€œçƒ­ç‚¹è¯æ±‡ç»Ÿè®¡â€â€œæ–°å¢çƒ­ç‚¹æ–°é—»â€â€œå¤±è´¥å¹³å°â€ä¸æ—¶é—´/ç‰ˆæœ¬æç¤ºã€‚
- format_title_for_platformï¼šæŒ‰å¹³å°å·®å¼‚åŒ–æ ¼å¼åŒ–æ ‡é¢˜ï¼ˆæ¥æºã€é“¾æ¥ã€æ—¶é—´ã€æ¬¡æ•°ã€æ–°å¢æ ‡è®°ã€æ’åé«˜äº®ï¼‰ã€‚
- format_rank_displayï¼šæŒ‰å¹³å°é€‰æ‹©é«˜äº®æ ·å¼ï¼Œç”Ÿæˆæ’ååŒºé—´å­—ç¬¦ä¸²ã€‚
- split_content_into_batchesï¼šè·¨å¹³å°åˆ†æ‰¹ç­–ç•¥ï¼Œä¿è¯æ‰¹æ¬¡å¤§å°ä¸åŸå­æ€§ï¼ˆè¯ç»„æ ‡é¢˜+ç¬¬ä¸€æ¡æ–°é—»ã€æ¥æºæ ‡é¢˜+ç¬¬ä¸€æ¡æ–°é—»ï¼‰ã€‚

ç« èŠ‚æ¥æº
- [context.py](file://trendradar/context.py#L308-L366)
- [renderer.py](file://trendradar/notification/renderer.py#L1-L261)
- [formatter.py](file://trendradar/report/formatter.py#L1-L224)
- [helpers.py](file://trendradar/report/helpers.py#L62-L126)
- [splitter.py](file://trendradar/notification/splitter.py#L23-L120)

## æ¶æ„æ€»è§ˆ
ä¸‹å›¾å±•ç¤ºä» AppContext åˆ°æ¸²æŸ“å™¨å†åˆ°æ ¼å¼åŒ–å·¥å…·çš„æ•´ä½“è°ƒç”¨é“¾è·¯ï¼Œä»¥åŠé…ç½®å‚æ•°å¯¹æ¸²æŸ“è¡Œä¸ºçš„å½±å“ã€‚

```mermaid
sequenceDiagram
participant Caller as "è°ƒç”¨æ–¹"
participant Ctx as "AppContext"
participant Fei as "render_feishu_content"
participant Ding as "render_dingtalk_content"
participant Fmt as "format_title_for_platform"
participant Help as "format_rank_display/clean_title"
Caller->>Ctx : è°ƒç”¨ render_feishu(report_data, update_info, mode)
Ctx->>Fei : ä¼ å…¥ report_data/update_info/mode/separator/reverse_content_order/get_time_func
Fei->>Fmt : æ ¼å¼åŒ–æ¯ä¸ªæ ‡é¢˜æ¥æº/é“¾æ¥/æ—¶é—´/æ¬¡æ•°/æ–°å¢æ ‡è®°
Fmt->>Help : ç”Ÿæˆæ’åé«˜äº®/æ¸…æ´—æ ‡é¢˜
Fei-->>Ctx : è¿”å›é£ä¹¦æ¶ˆæ¯æ–‡æœ¬
Caller->>Ctx : è°ƒç”¨ render_dingtalk(report_data, update_info, mode)
Ctx->>Ding : ä¼ å…¥ report_data/update_info/mode/reverse_content_order/get_time_func
Ding->>Fmt : æ ¼å¼åŒ–æ¯ä¸ªæ ‡é¢˜æ¥æº/é“¾æ¥/æ—¶é—´/æ¬¡æ•°/æ–°å¢æ ‡è®°
Fmt->>Help : ç”Ÿæˆæ’åé«˜äº®/æ¸…æ´—æ ‡é¢˜
Ding-->>Ctx : è¿”å›é’‰é’‰æ¶ˆæ¯æ–‡æœ¬
```

å›¾è¡¨æ¥æº
- [context.py](file://trendradar/context.py#L308-L366)
- [renderer.py](file://trendradar/notification/renderer.py#L1-L261)
- [formatter.py](file://trendradar/report/formatter.py#L1-L224)
- [helpers.py](file://trendradar/report/helpers.py#L62-L126)

## è¯¦ç»†ç»„ä»¶åˆ†æ

### AppContext.render_feishu ä¸ AppContext.render_dingtalk
- render_feishuï¼šè¯»å– FEISHU_MESSAGE_SEPARATOR ä½œä¸ºåˆ†éš”ç¬¦ï¼Œé€ä¼  REVERSE_CONTENT_ORDER ä¸ get_time_funcï¼Œè°ƒç”¨ render_feishu_content ç”Ÿæˆæ–‡æœ¬ã€‚
- render_dingtalkï¼šé€ä¼  REVERSE_CONTENT_ORDER ä¸ get_time_funcï¼Œè°ƒç”¨ render_dingtalk_content ç”Ÿæˆæ–‡æœ¬ã€‚
- split_contentï¼šåŸºäºé…ç½®çš„ DINGTALK_BATCH_SIZE/FEISHU_BATCH_SIZE/defaultï¼Œç»“åˆ feishu_separator ä¸ reverse_content_orderï¼Œå°†é•¿æ–‡æœ¬æ‹†åˆ†ä¸ºè‹¥å¹²æ‰¹æ¬¡ï¼Œç¡®ä¿å„å¹³å°å­—èŠ‚é™åˆ¶ä¸åŸå­æ€§ã€‚

ç« èŠ‚æ¥æº
- [context.py](file://trendradar/context.py#L308-L366)
- [config.yaml](file://config/config.yaml#L80-L110)

### render_feishu_content å®ç°è¦ç‚¹
- çƒ­ç‚¹è¯æ±‡ç»Ÿè®¡éƒ¨åˆ†
  - æ ‡é¢˜ï¼šä½¿ç”¨â€œğŸ“Š çƒ­ç‚¹è¯æ±‡ç»Ÿè®¡â€ã€‚
  - æ¯ä¸ªè¯ç»„åŒ…å«çƒ­åº¦ç­‰çº§å›¾æ ‡ï¼ˆğŸ”¥â‰¥10ã€ğŸ“ˆâ‰¥5ã€ğŸ“Œ<5ï¼‰ï¼Œå¹¶ä»¥åºåˆ—å·æ ‡æ³¨é¡ºåºã€‚
  - ä½¿ç”¨ HTML é¢œè‰²æ ‡ç­¾å¯¹è¯ç»„è®¡æ•°è¿›è¡Œå¼ºè°ƒï¼ˆçº¢è‰²/æ©™è‰²ï¼‰ã€‚
  - æ¯ä¸ªè¯ç»„ä¸‹ä¾æ¬¡åˆ—å‡ºæ ‡é¢˜ï¼Œé€šè¿‡ format_title_for_platform æŒ‰é£ä¹¦æ ¼å¼æ¸²æŸ“ï¼ˆæ¥æºã€é“¾æ¥ã€æ—¶é—´ã€æ¬¡æ•°ã€æ–°å¢æ ‡è®°ã€æ’åé«˜äº®ï¼‰ã€‚
  - è¯ç»„ä¹‹é—´ä½¿ç”¨ FEISHU_MESSAGE_SEPARATOR ä½œä¸ºåˆ†éš”ç¬¦ã€‚
- æ–°å¢çƒ­ç‚¹æ–°é—»éƒ¨åˆ†
  - æ ‡é¢˜ï¼šä½¿ç”¨â€œğŸ†• æœ¬æ¬¡æ–°å¢çƒ­ç‚¹æ–°é—»â€ï¼Œå¹¶æ˜¾ç¤ºæ€»æ•°ã€‚
  - æŒ‰æ¥æºèšåˆï¼Œæ¯ä¸ªæ¥æºä¸‹åˆ—å‡ºæ ‡é¢˜ï¼›ä¸ºé¿å…é‡å¤æ ‡è®°â€œæ–°å¢â€ï¼Œå¤åˆ¶æ ‡é¢˜æ•°æ®å¹¶æ¸…ç©º is_new æ ‡è®°åå†æ¸²æŸ“ã€‚
  - ä½¿ç”¨â€œ---â€ä½œä¸ºæ¥æºä¹‹é—´çš„åˆ†éš”ç¬¦ã€‚
- å†…å®¹é¡ºåº
  - è‹¥ reverse_content_order ä¸ºçœŸï¼šæ–°å¢çƒ­ç‚¹åœ¨å‰ï¼Œçƒ­ç‚¹ç»Ÿè®¡åœ¨åï¼›å¦åˆ™ç›¸åã€‚
- å¤±è´¥å¹³å°ä¿¡æ¯
  - è‹¥å­˜åœ¨ failed_idsï¼Œæ¸²æŸ“â€œâš ï¸ æ•°æ®è·å–å¤±è´¥çš„å¹³å°â€ï¼Œå¹¶åœ¨æ¯è¡Œä½¿ç”¨çº¢è‰²å¼ºè°ƒå¤±è´¥å¹³å° IDã€‚
- æ—¶é—´ä¸ç‰ˆæœ¬æç¤º
  - åœ¨æ–‡æœ¬æœ«å°¾è¿½åŠ â€œæ›´æ–°æ—¶é—´ï¼šYYYY-MM-DD HH:MM:SSâ€çš„ç°è‰²æç¤ºã€‚
  - è‹¥ update_info å­˜åœ¨ï¼Œè¿½åŠ â€œå‘ç°æ–°ç‰ˆæœ¬ remote_versionï¼Œå½“å‰ current_versionâ€çš„ç°è‰²æç¤ºã€‚

ç« èŠ‚æ¥æº
- [renderer.py](file://trendradar/notification/renderer.py#L14-L135)
- [formatter.py](file://trendradar/report/formatter.py#L52-L72)
- [helpers.py](file://trendradar/report/helpers.py#L62-L126)
- [config.yaml](file://config/config.yaml#L90-L110)

### render_dingtalk_content å®ç°è¦ç‚¹
- å¤´éƒ¨ä¿¡æ¯
  - åŒ…å«â€œæ€»æ–°é—»æ•°â€â€œæ—¶é—´â€â€œç±»å‹ï¼šçƒ­ç‚¹åˆ†ææŠ¥å‘Šâ€ï¼Œå¹¶ä»¥â€œ---â€åˆ†éš”ã€‚
- çƒ­ç‚¹è¯æ±‡ç»Ÿè®¡éƒ¨åˆ†
  - æ ‡é¢˜ï¼šä½¿ç”¨â€œğŸ“Š çƒ­ç‚¹è¯æ±‡ç»Ÿè®¡â€ã€‚
  - çƒ­åº¦ç­‰çº§å›¾æ ‡ä¸è®¡æ•°é‡‡ç”¨ç²—ä½“å¼ºè°ƒï¼›è¯ç»„é—´åŒæ ·ä½¿ç”¨â€œ---â€åˆ†éš”ã€‚
  - æ ‡é¢˜æ¸²æŸ“é€šè¿‡ format_title_for_platform æŒ‰é’‰é’‰æ ¼å¼æ¸²æŸ“ï¼ˆæ¥æºã€é“¾æ¥ã€æ—¶é—´ã€æ¬¡æ•°ã€æ–°å¢æ ‡è®°ã€æ’åé«˜äº®ï¼‰ã€‚
- æ–°å¢çƒ­ç‚¹æ–°é—»éƒ¨åˆ†
  - æ ‡é¢˜ï¼šä½¿ç”¨â€œğŸ†• æœ¬æ¬¡æ–°å¢çƒ­ç‚¹æ–°é—»â€ï¼Œå¹¶æ˜¾ç¤ºæ€»æ•°ã€‚
  - æŒ‰æ¥æºèšåˆï¼Œæ¯ä¸ªæ¥æºä¸‹åˆ—å‡ºæ ‡é¢˜ï¼›åŒæ ·æ¸…ç©º is_new æ ‡è®°åæ¸²æŸ“ã€‚
- å†…å®¹é¡ºåº
  - è‹¥ reverse_content_order ä¸ºçœŸï¼šæ–°å¢çƒ­ç‚¹åœ¨å‰ï¼Œçƒ­ç‚¹ç»Ÿè®¡åœ¨åï¼›å¦åˆ™ç›¸åã€‚
- å¤±è´¥å¹³å°ä¿¡æ¯
  - è‹¥å­˜åœ¨ failed_idsï¼Œæ¸²æŸ“â€œâš ï¸ æ•°æ®è·å–å¤±è´¥çš„å¹³å°â€ï¼Œå¹¶åœ¨æ¯è¡Œä½¿ç”¨ç²—ä½“å¼ºè°ƒå¤±è´¥å¹³å° IDã€‚
- æ—¶é—´ä¸ç‰ˆæœ¬æç¤º
  - åœ¨æ–‡æœ¬æœ«å°¾è¿½åŠ â€œæ›´æ–°æ—¶é—´ï¼šYYYY-MM-DD HH:MM:SSâ€çš„å¼•ç”¨æ ·å¼æç¤ºã€‚
  - è‹¥ update_info å­˜åœ¨ï¼Œè¿½åŠ â€œå‘ç°æ–°ç‰ˆæœ¬ remote_versionï¼Œå½“å‰ current_versionâ€çš„ç²—ä½“æç¤ºã€‚

ç« èŠ‚æ¥æº
- [renderer.py](file://trendradar/notification/renderer.py#L137-L261)
- [formatter.py](file://trendradar/report/formatter.py#L74-L94)
- [helpers.py](file://trendradar/report/helpers.py#L62-L126)
- [config.yaml](file://config/config.yaml#L90-L110)

### æ ‡é¢˜æ ¼å¼åŒ–ä¸æ’åé«˜äº®
- format_title_for_platform
  - é£ä¹¦ï¼šä½¿ç”¨ HTML é¢œè‰²æ ‡ç­¾åŒ…è£¹æ¥æºã€æ—¶é—´ã€æ¬¡æ•°ç­‰ï¼›æ–°å¢æ ‡é¢˜å‰ç¼€â€œğŸ†•â€ï¼›æ’åé«˜äº®é‡‡ç”¨ HTML é¢œè‰²æ ‡ç­¾ä¸ç²—ä½“ç»„åˆã€‚
  - é’‰é’‰ï¼šä½¿ç”¨æ™®é€šç²—ä½“åŒ…è£¹æ¥æºã€æ—¶é—´ã€æ¬¡æ•°ç­‰ï¼›æ–°å¢æ ‡é¢˜å‰ç¼€â€œğŸ†•â€ï¼›æ’åé«˜äº®é‡‡ç”¨ç²—ä½“ã€‚
  - å…¶ä»–å¹³å°ï¼šé‡‡ç”¨å„è‡ªå¹³å°çš„å¼ºè°ƒæ–¹å¼ï¼ˆå¦‚ Telegram ä½¿ç”¨ <b>/<code>ï¼ŒSlack ä½¿ç”¨ * ç­‰ï¼‰ã€‚
- format_rank_display
  - æ ¹æ®å¹³å°ç±»å‹é€‰æ‹©ä¸åŒçš„é«˜äº®èµ·æ­¢æ ‡è®°ï¼ˆHTML/é£ä¹¦/é’‰é’‰/ä¼ä¸šå¾®ä¿¡/Telegram/Slack/é»˜è®¤ markdownï¼‰ã€‚
  - å½“æœ€å°æ’å â‰¤ rank_threshold æ—¶ï¼Œä½¿ç”¨é«˜äº®æ ‡è®°åŒ…è£¹æ’ååŒºé—´ï¼›å¦åˆ™ä»…æ˜¾ç¤ºæ™®é€šåŒºé—´ã€‚

ç« èŠ‚æ¥æº
- [formatter.py](file://trendradar/report/formatter.py#L1-L224)
- [helpers.py](file://trendradar/report/helpers.py#L62-L126)

### å†…å®¹é¡ºåºä¸åˆ†éš”ç¬¦
- reverse_content_order
  - é£ä¹¦ä¸é’‰é’‰æ¸²æŸ“å™¨å‡æ”¯æŒè¯¥é…ç½®ï¼Œæ§åˆ¶â€œæ–°å¢çƒ­ç‚¹æ–°é—»â€ä¸â€œçƒ­ç‚¹è¯æ±‡ç»Ÿè®¡â€çš„å‰åé¡ºåºã€‚
- åˆ†éš”ç¬¦
  - é£ä¹¦ï¼šä½¿ç”¨ FEISHU_MESSAGE_SEPARATORï¼ˆé»˜è®¤ä¸ºé•¿æ¨ªçº¿ï¼‰ä½œä¸ºè¯ç»„é—´åˆ†éš”ç¬¦ã€‚
  - é’‰é’‰ï¼šä½¿ç”¨â€œ---â€ä½œä¸ºè¯ç»„é—´ä¸æ¥æºé—´åˆ†éš”ç¬¦ã€‚
- åˆ†æ‰¹ç­–ç•¥
  - split_content_into_batches æä¾›è·¨å¹³å°åˆ†æ‰¹èƒ½åŠ›ï¼Œç¡®ä¿â€œè¯ç»„æ ‡é¢˜+ç¬¬ä¸€æ¡æ–°é—»â€â€œæ¥æºæ ‡é¢˜+ç¬¬ä¸€æ¡æ–°é—»â€çš„åŸå­æ€§ï¼Œé¿å…æˆªæ–­ç ´åå®Œæ•´æ€§ï¼›åŒæ—¶æŒ‰å¹³å°å­—èŠ‚ä¸Šé™è¿›è¡Œå®‰å…¨æˆªæ–­ä¸æ‰¹æ¬¡å¤´éƒ¨é¢„ç•™ã€‚

ç« èŠ‚æ¥æº
- [renderer.py](file://trendradar/notification/renderer.py#L1-L261)
- [splitter.py](file://trendradar/notification/splitter.py#L23-L120)
- [config.yaml](file://config/config.yaml#L90-L110)

### å¤±è´¥å¹³å°ä¿¡æ¯ä¸ç‰ˆæœ¬æ›´æ–°æç¤º
- å¤±è´¥å¹³å°ä¿¡æ¯
  - é£ä¹¦ï¼šä½¿ç”¨çº¢è‰²å¼ºè°ƒå¤±è´¥å¹³å° IDã€‚
  - é’‰é’‰ï¼šä½¿ç”¨ç²—ä½“å¼ºè°ƒå¤±è´¥å¹³å° IDã€‚
- ç‰ˆæœ¬æ›´æ–°æç¤º
  - é£ä¹¦ä¸é’‰é’‰å‡åœ¨æ–‡æœ¬æœ«å°¾è¿½åŠ ç‰ˆæœ¬æç¤ºï¼›è‹¥ update_info ç¼ºå¤±åˆ™ä¸æ˜¾ç¤ºã€‚

ç« èŠ‚æ¥æº
- [renderer.py](file://trendradar/notification/renderer.py#L1-L261)

## ä¾èµ–å…³ç³»åˆ†æ
- AppContext ä¾èµ–æ¸²æŸ“å™¨ä¸åˆ†æ‰¹æ¨¡å—ï¼Œé€šè¿‡é…ç½®é¡¹é©±åŠ¨æ¸²æŸ“ä¸åˆ†æ‰¹è¡Œä¸ºã€‚
- æ¸²æŸ“å™¨ä¾èµ–æ ‡é¢˜æ ¼å¼åŒ–ä¸æŠ¥å‘Šè¾…åŠ©å‡½æ•°ï¼Œç¡®ä¿è·¨å¹³å°ä¸€è‡´æ€§ä¸å¯è¯»æ€§ã€‚
- é…ç½®æ–‡ä»¶æä¾›åˆ†éš”ç¬¦ã€å†…å®¹é¡ºåºã€æ‰¹é‡å¤§å°ç­‰å…³é”®å‚æ•°ï¼Œè´¯ç©¿æ¸²æŸ“ä¸åˆ†æ‰¹æµç¨‹ã€‚

```mermaid
graph LR
Ctx["AppContext"] --> Fei["render_feishu_content"]
Ctx --> Ding["render_dingtalk_content"]
Ctx --> Split["split_content_into_batches"]
Fei --> Fmt["format_title_for_platform"]
Ding --> Fmt
Fmt --> Help["format_rank_display / clean_title / html_escape"]
Cfg["config.yaml"] --> Ctx
Cfg --> Fei
Cfg --> Ding
```

å›¾è¡¨æ¥æº
- [context.py](file://trendradar/context.py#L308-L366)
- [renderer.py](file://trendradar/notification/renderer.py#L1-L261)
- [formatter.py](file://trendradar/report/formatter.py#L1-L224)
- [helpers.py](file://trendradar/report/helpers.py#L1-L126)
- [config.yaml](file://config/config.yaml#L80-L110)
- [splitter.py](file://trendradar/notification/splitter.py#L1-L120)

## æ€§èƒ½è€ƒé‡
- å­—èŠ‚å®‰å…¨æˆªæ–­ï¼šåˆ†æ‰¹æ¨¡å—ä½¿ç”¨ truncate_to_bytes ä¸ get_max_batch_header_size é¢„ç•™å¤´éƒ¨ç©ºé—´ï¼Œé¿å…å¤šå­—èŠ‚å­—ç¬¦æˆªæ–­å¯¼è‡´çš„ä¹±ç ã€‚
- åŸå­æ€§ä¿éšœï¼šåˆ†æ‰¹ç­–ç•¥ç¡®ä¿â€œè¯ç»„æ ‡é¢˜+ç¬¬ä¸€æ¡æ–°é—»â€â€œæ¥æºæ ‡é¢˜+ç¬¬ä¸€æ¡æ–°é—»â€ä½œä¸ºä¸€ä¸ªæ•´ä½“è¿›å…¥æ‰¹æ¬¡ï¼Œå‡å°‘é‡å¤å†…å®¹ä¸æå‡å¯è¯»æ€§ã€‚
- æ‰¹æ¬¡å¤§å°é…ç½®ï¼šä¸åŒå¹³å°è®¾ç½®ä¸åŒä¸Šé™ï¼ˆå¦‚é£ä¹¦ 29000 å­—èŠ‚ã€é’‰é’‰ 20000 å­—èŠ‚ï¼‰ï¼Œé¿å…è§¦å‘å¹³å°é™åˆ¶ã€‚
- æ—¶é—´å‡½æ•°æ³¨å…¥ï¼šé€šè¿‡ get_time_func æ³¨å…¥æ—¶é—´å‡½æ•°ï¼Œä¾¿äºæµ‹è¯•ä¸ç»Ÿä¸€æ—¶åŒºæ˜¾ç¤ºã€‚

ç« èŠ‚æ¥æº
- [splitter.py](file://trendradar/notification/splitter.py#L50-L120)
- [context.py](file://trendradar/context.py#L341-L366)
- [config.yaml](file://config/config.yaml#L80-L110)

## æ•…éšœæ’æŸ¥æŒ‡å—
- é£ä¹¦/é’‰é’‰æ¶ˆæ¯è¿‡é•¿
  - æ£€æŸ¥ FEISHU_MESSAGE_SEPARATOR ä¸ REVERSE_CONTENT_ORDER é…ç½®æ˜¯å¦åˆç†ï¼›å¿…è¦æ—¶é™ä½æ¯è¯ç»„/æ¥æºçš„æ–°é—»æ•°é‡æˆ–è°ƒæ•´åˆ†éš”ç¬¦é•¿åº¦ã€‚
  - ç¡®è®¤ FEISHU_BATCH_SIZE/DINGTALK_BATCH_SIZE é…ç½®æœªè¢«æ„å¤–ä¿®æ”¹ã€‚
- æ ‡é¢˜æ˜¾ç¤ºå¼‚å¸¸
  - ç¡®è®¤ format_title_for_platform çš„ show_source å‚æ•°ä¸ is_new æ ‡è®°æ˜¯å¦æŒ‰é¢„æœŸä¼ é€’ï¼›æ£€æŸ¥ clean_title æ˜¯å¦æ­£ç¡®æ¸…æ´—æ ‡é¢˜ã€‚
- æ’åé«˜äº®ä¸ç”Ÿæ•ˆ
  - æ£€æŸ¥ rank_threshold ä¸ format_rank_display çš„å¹³å°é«˜äº®æ ·å¼é…ç½®ï¼›ç¡®è®¤ ranks åˆ—è¡¨éç©ºã€‚
- ç‰ˆæœ¬æç¤ºæœªæ˜¾ç¤º
  - ç¡®è®¤ update_info æ˜¯å¦ä¼ å…¥ï¼›æ£€æŸ¥ app.show_version_update æ˜¯å¦ä¸º trueã€‚

ç« èŠ‚æ¥æº
- [renderer.py](file://trendradar/notification/renderer.py#L1-L261)
- [formatter.py](file://trendradar/report/formatter.py#L1-L224)
- [helpers.py](file://trendradar/report/helpers.py#L62-L126)
- [config.yaml](file://config/config.yaml#L1-L20)

## ç»“è®º
- render_feishu_content ä¸ render_dingtalk_content é€šè¿‡ç»Ÿä¸€çš„æ ‡é¢˜æ ¼å¼åŒ–ä¸æŠ¥å‘Šè¾…åŠ©å‡½æ•°ï¼Œå®ç°äº†è·¨å¹³å°ä¸€è‡´çš„æ¸²æŸ“ä½“éªŒã€‚
- é£ä¹¦ä¸é’‰é’‰åœ¨é¢œè‰²ã€å¼ºè°ƒä¸åˆ†éš”ç¬¦ä¸Šå­˜åœ¨å·®å¼‚ï¼Œä½†é€šè¿‡å¹³å°åˆ†æ”¯ä¸é…ç½®é¡¹å®ç°äº†æ¸…æ™°çš„å·®å¼‚åŒ–å‘ˆç°ã€‚
- reverse_content_order ä¸ FEISHU_MESSAGE_SEPARATOR ç­‰é…ç½®é¡¹æä¾›äº†çµæ´»çš„å†…å®¹ç»„ç»‡æ–¹å¼ï¼Œæ»¡è¶³ä¸åŒå›¢é˜Ÿçš„é˜…è¯»åå¥½ã€‚
- åˆ†æ‰¹ç­–ç•¥ä¸å­—èŠ‚å®‰å…¨æˆªæ–­ç¡®ä¿äº†é•¿æ–‡æœ¬åœ¨å„å¹³å°çš„ç¨³å®šä¼ è¾“ä¸å¯è¯»æ€§ã€‚
- ç‰ˆæœ¬æ›´æ–°æç¤ºä¸å¤±è´¥å¹³å°ä¿¡æ¯å¢å¼ºäº†å¯è§‚æµ‹æ€§ä¸é—®é¢˜å®šä½æ•ˆç‡ã€‚