# 配对配置验证机制

<cite>
**本文档引用文件**  
- [senders.py](file://trendradar/notification/senders.py#L377-L802)
- [dispatcher.py](file://trendradar/notification/dispatcher.py#L252-L351)
- [config.py](file://trendradar/core/config.py#L40-L94)
- [config.yaml](file://config/config.yaml#L144-L153)
</cite>

## 目录
1. [Telegram 配对配置验证](#telegram-配对配置验证)
2. [ntfy 配对配置验证](#ntfy-配对配置验证)
3. [验证失败处理流程](#验证失败处理流程)

## Telegram 配对配置验证

Telegram 通知渠道的发送功能通过 `_send_telegram()` 方法实现，该方法位于 `dispatcher.py` 文件中。其核心验证机制依赖于 `validate_paired_configs()` 函数，确保 `TELEGRAM_BOT_TOKEN` 和 `TELEGRAM_CHAT_ID` 的配对有效性。

验证流程如下：
1.  **配置解析**：使用 `parse_multi_account_config()` 函数解析 `TELEGRAM_BOT_TOKEN` 和 `TELEGRAM_CHAT_ID` 环境变量。该函数以分号 `;` 为分隔符，将字符串转换为字符串列表。
2.  **配对验证**：调用 `validate_paired_configs()` 函数，传入一个包含 `bot_token` 和 `chat_id` 键的字典。
3.  **数量与非空校验**：`validate_paired_configs()` 函数执行以下关键检查：
    *   **数量一致性**：检查 `bot_token` 列表和 `chat_id` 列表的长度是否相等。如果长度不一致，验证失败。
    *   **非空性**：通过 `required_keys=["bot_token", "chat_id"]` 参数，确保这两个配置项均存在且不为空列表。如果任一配置项为空，验证失败。
4.  **结果处理**：如果 `validate_paired_configs()` 返回 `False` 或账号数量为 0，`_send_telegram()` 方法会直接返回 `False`，跳过后续的发送逻辑。

此机制确保了每个 Telegram Bot Token 都有且仅有一个对应的 Chat ID，防止了因配置不匹配导致的发送失败。

**Section sources**
- [dispatcher.py](file://trendradar/notification/dispatcher.py#L252-L302)
- [config.py](file://trendradar/core/config.py#L40-L94)
- [config.yaml](file://config/config.yaml#L144-L145)

## ntfy 配对配置验证

ntfy 通知渠道的发送功能通过 `_send_ntfy()` 方法实现，其验证逻辑与 Telegram 类似但更为直接，主要在 `dispatcher.py` 文件中完成。

验证流程如下：
1.  **基础配置检查**：首先检查 `NTFY_SERVER_URL` 和 `NTFY_TOPIC` 是否存在且非空。如果任一为空，直接返回 `False`。
2.  **Token 数量校验**：当 `NTFY_TOKEN` 被配置时（即不为空），会进行严格的数量匹配检查。
3.  **条件判断**：代码通过 `if ntfy_tokens and len(ntfy_tokens) != len(ntfy_topics):` 进行判断。
4.  **错误提示**：如果 `NTFY_TOKEN` 存在且其数量与 `NTFY_TOPIC` 的数量不一致，系统会打印一条明确的错误信息：`"❌ ntfy 配置错误：topic 数量(X)与 token 数量(Y)不一致，跳过 ntfy 推送"`，并直接返回 `False`，终止发送流程。
5.  **可选性**：如果 `NTFY_TOKEN` 未配置，则跳过此校验，允许无认证的推送。

这种设计确保了当用户启用了基于 Token 的私有主题认证时，每个主题都有一个对应的访问令牌，保证了推送的安全性和准确性。

**Section sources**
- [dispatcher.py](file://trendradar/notification/dispatcher.py#L303-L351)
- [config.yaml](file://config/config.yaml#L151-L153)

## 验证失败处理流程

当 Telegram 或 ntfy 的配对配置验证失败时，系统会遵循一套清晰的处理流程，旨在快速定位问题并防止无效的发送尝试。

1.  **错误日志输出**：
    *   **Telegram**：`validate_paired_configs()` 函数会在验证失败时输出通用的错误信息，如 `"❌ Telegram 配置错误：配对配置数量不一致，将跳过该渠道推送"`，并列出每个配置项的实际数量。
    *   **ntfy**：`_send_ntfy()` 方法会输出更具体的错误信息，明确指出 `topic` 和 `token` 的数量差异。
2.  **流程终止**：一旦验证失败，相应的 `_send_telegram()` 或 `_send_ntfy()` 方法会立即返回 `False`。
3.  **结果记录**：这个 `False` 结果会被 `NotificationDispatcher.dispatch_all()` 方法捕获，并记录在返回的 `results` 字典中，标记该渠道的发送状态为失败。
4.  **用户定位**：用户可以通过查看程序运行日志中的错误信息，快速识别是配置项缺失、数量不匹配还是存在空值，从而进行修正。

整个处理流程以用户友好和健壮性为核心，通过详细的日志和即时的流程中断，帮助用户高效地解决配置问题。

**Section sources**
- [dispatcher.py](file://trendradar/notification/dispatcher.py#L268-L274)
- [dispatcher.py](file://trendradar/notification/dispatcher.py#L320-L324)
- [config.py](file://trendradar/core/config.py#L88-L92)